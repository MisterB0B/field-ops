<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Field Ops Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0f">
    <!-- Unified Cloud Sync & Permissions -->
    <script src="https://thelightparkops.com/shared/cloud-sync.js"></script>
    <script src="https://thelightparkops.com/shared/supabase-auth.js?v=20260211f"></script>
    <script src="https://thelightparkops.com/shared/activity-logger.js?v=20260211f"></script>
    <script src="https://thelightparkops.com/shared/auth-gate.js?v=20260211f" data-app="Field Ops" data-icon="üîß"></script>
    <script src="https://thelightparkops.com/shared/permissions.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --border: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent-purple: #a855f7;
            --accent-teal: #06d6a0;
            --accent-pink: #ff4fd8;
            --status-green: #22c55e;
            --status-yellow: #eab308;
            --status-red: #ef4444;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1025 100%);
        }
        
        .login-screen.hidden { display: none; }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        
        .pin-display {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--accent-purple);
            transition: all 0.2s;
        }
        
        .pin-dot.filled {
            background: var(--accent-purple);
            box-shadow: 0 0 10px var(--accent-purple);
        }
        
        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 280px;
        }
        
        .pin-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pin-btn:hover { background: var(--bg-secondary); }
        .pin-btn:active { transform: scale(0.95); }
        .pin-btn.clear { font-size: 14px; }
        
        .login-error {
            color: var(--status-red);
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .login-error.show { opacity: 1; }
        
        /* Main App */
        .app-container { display: none; }
        .app-container.active { display: block; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .user-badge {
            background: var(--accent-purple);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .mode-toggle {
            display: flex;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            color: white;
        }
        
        /* Dashboard Grid */
        .dashboard {
            padding: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .venue-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 768px) {
            .venue-grid { grid-template-columns: repeat(4, 1fr); }
        }
        
        .venue-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .venue-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-purple);
        }
        
        .venue-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .venue-card.status-green::before { background: var(--status-green); }
        .venue-card.status-yellow::before { background: var(--status-yellow); }
        .venue-card.status-red::before { background: var(--status-red); }
        .venue-card.status-gray::before { background: var(--border); }
        
        .venue-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .venue-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .venue-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .venue-stat .check { color: var(--status-green); }
        .venue-stat .pending { color: var(--status-yellow); }
        .venue-stat .missing { color: var(--status-red); }
        
        /* Staff List */
        .staff-section {
            margin-bottom: 30px;
        }
        
        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .staff-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .staff-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .staff-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .staff-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        .staff-details h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .staff-details p {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .staff-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.checked-in {
            background: rgba(34, 197, 94, 0.2);
            color: var(--status-green);
        }
        
        .status-badge.not-checked-in {
            background: rgba(239, 68, 68, 0.2);
            color: var(--status-red);
        }
        
        .status-badge.pending {
            background: rgba(234, 179, 8, 0.2);
            color: var(--status-yellow);
        }
        
        .check-in-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .gps-verified {
            font-size: 11px;
            color: var(--status-green);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Task Progress */
        .task-progress {
            background: var(--bg-secondary);
            border-radius: 8px;
            height: 6px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .task-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-teal));
            transition: width 0.3s;
        }
        
        /* Issues/Flags */
        .issues-section {
            margin-bottom: 30px;
        }
        
        .issue-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--status-red);
            margin-bottom: 10px;
        }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .issue-venue {
            font-size: 12px;
            color: var(--accent-purple);
            font-weight: 600;
        }
        
        .issue-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .issue-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .issue-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .issue-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .issue-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .issue-btn.resolve {
            background: var(--status-green);
            color: white;
        }
        
        .issue-btn.escalate {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            padding: 10px 20px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-btn.active { color: var(--accent-purple); }
        .nav-btn span { font-size: 11px; font-weight: 500; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-purple);
        }
        
        .form-submit {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Venue Detail View */
        .venue-detail { display: none; }
        .venue-detail.active { display: block; }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--accent-purple);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            padding: 16px 20px;
        }
        
        .detail-header {
            padding: 0 20px 20px;
        }
        
        .detail-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .detail-meta {
            display: flex;
            gap: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .checklist-section {
            padding: 20px;
        }
        
        .checklist-category {
            margin-bottom: 24px;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .category-name {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-purple);
        }
        
        .category-progress {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .category-progress.complete {
            background: rgba(34, 197, 94, 0.2);
            color: var(--status-green);
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .checklist-item.done {
            opacity: 0.6;
            background: var(--bg-secondary);
        }
        
        .checklist-item.done .checklist-title {
            text-decoration: line-through;
        }
        
        .checklist-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checklist-checkbox.checked {
            background: var(--status-green);
            border-color: var(--status-green);
        }
        
        .checklist-content {
            flex: 1;
        }
        
        .checklist-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .checklist-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .photo-required {
            font-size: 11px;
            color: var(--accent-pink);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        /* Logout */
        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
        }
        
        .logout-btn:hover { color: var(--status-red); }
    </style>
</head>
<body>
    <!-- Login Screen (hidden in demo mode) -->
    <div class="login-screen hidden" id="loginScreen">
        <div class="login-logo">üìã</div>
        <h1 class="login-title">Field Ops Tracker</h1>
        <p class="login-subtitle">Bob & Zac Only</p>
        
        <div class="pin-display">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
        
        <div class="pin-pad">
            <button class="pin-btn" onclick="addPin('1')">1</button>
            <button class="pin-btn" onclick="addPin('2')">2</button>
            <button class="pin-btn" onclick="addPin('3')">3</button>
            <button class="pin-btn" onclick="addPin('4')">4</button>
            <button class="pin-btn" onclick="addPin('5')">5</button>
            <button class="pin-btn" onclick="addPin('6')">6</button>
            <button class="pin-btn" onclick="addPin('7')">7</button>
            <button class="pin-btn" onclick="addPin('8')">8</button>
            <button class="pin-btn" onclick="addPin('9')">9</button>
            <button class="pin-btn clear" onclick="clearPin()">Clear</button>
            <button class="pin-btn" onclick="addPin('0')">0</button>
            <button class="pin-btn clear" onclick="backspace()">‚å´</button>
        </div>
        
        <p class="login-error" id="loginError">Invalid PIN</p>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <a href="https://thelightparkops.com" style="color: #a855f7; text-decoration: none; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.color='#06d6a0'" onmouseout="this.style.color='#a855f7'">
                        ‚Üê Dashboard
                    </a>
                    <h1 class="header-title">üìã Field Ops</h1>
                </div>
                <div class="header-user">
                    <span class="user-badge">Demo Mode</span>
                    <span id="syncStatus" style="font-size: 10px; color: #8888a0; margin-left: 8px;">‚òÅÔ∏è</span>
                </div>
            </div>
            <div class="mode-toggle">
                <button class="mode-btn active" id="buildModeBtn" onclick="setMode('build')">
                    üî® Build Season
                </button>
                <button class="mode-btn" id="showModeBtn" onclick="setMode('show')">
                    üéÑ Show Season
                </button>
            </div>
        </div>
        
        <!-- Dashboard View -->
        <div class="dashboard" id="dashboardView">
            <!-- Venue Grid -->
            <h3 class="section-title">All Venues</h3>
            <div class="venue-grid" id="venueGrid"></div>
            
            <!-- Active Issues -->
            <div class="issues-section" id="issuesSection">
                <h3 class="section-title">‚ö†Ô∏è Issues Requiring Attention</h3>
                <div id="issuesList"></div>
            </div>
            
            <!-- Staff Overview -->
            <div class="staff-section">
                <div class="staff-header">
                    <h3 class="section-title" id="staffSectionTitle">Build Leads</h3>
                    <button class="add-btn" onclick="openAddStaffModal()">+ Add</button>
                </div>
                <div class="staff-list" id="staffList"></div>
            </div>
        </div>
        
        <!-- Venue Detail View -->
        <div class="venue-detail" id="venueDetailView">
            <button class="back-btn" onclick="showDashboard()">‚Üê Back to All Venues</button>
            <div class="detail-header">
                <h2 class="detail-title" id="detailVenueName">Katy</h2>
                <div class="detail-meta">
                    <span id="detailStaffCount">3 Staff Assigned</span>
                    <span id="detailTaskProgress">5/8 Tasks Done</span>
                </div>
            </div>
            
            <div class="checklist-section">
                <h3 class="section-title">Today's Checklist</h3>
                <div id="checklistItems"></div>
            </div>
            
            <!-- CAD Notes Section -->
            <div id="cadNotesSection" style="display: none; padding: 0 20px; margin-bottom: 24px;">
                <h3 class="section-title" style="color: var(--accent-teal);">üìê CAD Draftsman Notes</h3>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                    <div id="cadNotesContent" style="color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;"></div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--text-secondary);">
                        <span id="cadNotesTimestamp"></span>
                    </div>
                </div>
            </div>
            
            <div class="staff-section" style="padding: 0 20px;">
                <h3 class="section-title">Assigned Staff</h3>
                <div class="staff-list" id="venueStaffList"></div>
            </div>
        </div>
        
        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('dashboard')">
                <span style="font-size: 20px;">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="nav-btn" onclick="switchTab('staff')">
                <span style="font-size: 20px;">üë•</span>
                <span>Staff</span>
            </button>
            <button class="nav-btn" onclick="switchTab('tasks')">
                <span style="font-size: 20px;">‚úÖ</span>
                <span>Tasks</span>
            </button>
            <button class="nav-btn" onclick="switchTab('reports')">
                <span style="font-size: 20px;">üìà</span>
                <span>Reports</span>
            </button>
        </nav>
    </div>
    
    <!-- Add Staff Modal -->
    <div class="modal-overlay" id="addStaffModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Staff Member</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="staffName" placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="staffPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="staffRole">
                        <option value="build-lead">Build Lead</option>
                        <option value="show-tech">Show Tech</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Venue</label>
                    <select class="form-select" id="staffVenue">
                        <option value="katy">Katy</option>
                        <option value="spring">Spring</option>
                        <option value="selma">Selma</option>
                        <option value="missions">Missions</option>
                        <option value="arlington">Arlington</option>
                        <option value="frisco">Frisco</option>
                        <option value="round-rock">Round Rock</option>
                        <option value="okc">Oklahoma City</option>
                    </select>
                </div>
                <button class="form-submit" onclick="addStaff()">Add Staff Member</button>
            </div>
        </div>
    </div>

    <script>
        // ========== PERMISSION CHECK ==========
        // Check if user has access to Field Ops (runs after login)
        function checkFieldOpsPermission() {
            if (typeof TLPPermissions !== 'undefined') {
                const user = TLPPermissions.getCurrentUser();
                if (user && !TLPPermissions.hasAppAccess('field-ops')) {
                    TLPPermissions.showAccessDenied('field-ops', user);
                    return false;
                }
                // Log access
                if (user) {
                    TLPPermissions.logAction('view', 'Accessed Field Ops');
                }
            }
            return true;
        }
        
        // ========== CONFIG ==========
        const PINS = {
            '0808': { name: 'Bob', role: 'owner' },
            '2626': { name: 'Zac', role: 'tech-lead' }
        };
        
        const VENUES = [
            { id: 'katy', name: 'Katy', region: 'Houston' },
            { id: 'spring', name: 'Spring', region: 'Houston' },
            { id: 'selma', name: 'Selma', region: 'San Antonio' },
            { id: 'missions', name: 'Missions', region: 'San Antonio' },
            { id: 'arlington', name: 'Arlington', region: 'DFW' },
            { id: 'frisco', name: 'Frisco', region: 'DFW' },
            { id: 'round-rock', name: 'Round Rock', region: 'Austin' },
            { id: 'okc', name: 'Oklahoma City', region: 'Oklahoma' }
        ];
        
        const BUILD_TASKS = [
            // === ARRIVAL & SETUP ===
            { id: 'arrival', title: 'Arrived On Site', photo: false, category: 'Arrival' },
            { id: 'gps-checkin', title: 'GPS Check-In Verified', photo: false, category: 'Arrival' },
            { id: 'team-headcount', title: 'Team Headcount Confirmed', photo: false, category: 'Arrival' },
            { id: 'team-briefing', title: 'Daily Briefing / Task Assignment', photo: false, category: 'Arrival' },
            
            // === SAFETY ===
            { id: 'safety-walk', title: 'Safety Walkthrough Complete', photo: true, category: 'Safety' },
            { id: 'ppe-check', title: 'PPE Check - All Team', photo: false, category: 'Safety' },
            { id: 'hazard-clear', title: 'Hazards Cleared / Marked', photo: true, category: 'Safety' },
            { id: 'first-aid', title: 'First Aid Kit Stocked', photo: false, category: 'Safety' },
            
            // === EQUIPMENT & MATERIALS ===
            { id: 'equipment-check', title: 'Equipment Inventory Verified', photo: true, category: 'Equipment' },
            { id: 'tools-accounted', title: 'Tools Accounted For', photo: false, category: 'Equipment' },
            { id: 'materials-received', title: 'Materials Delivery Received', photo: true, category: 'Equipment' },
            { id: 'forklift-check', title: 'Forklift / Lift Equipment Checked', photo: false, category: 'Equipment' },
            
            // === BUILD PROGRESS ===
            { id: 'zone-a-progress', title: 'Zone A Progress Update', photo: true, category: 'Build' },
            { id: 'zone-b-progress', title: 'Zone B Progress Update', photo: true, category: 'Build' },
            { id: 'zone-c-progress', title: 'Zone C Progress Update', photo: true, category: 'Build' },
            { id: 'prop-assembly', title: 'Prop Assembly Status', photo: true, category: 'Build' },
            { id: 'wiring-progress', title: 'Wiring / Electrical Progress', photo: true, category: 'Build' },
            { id: 'structural-check', title: 'Structural Integrity Check', photo: false, category: 'Build' },
            
            // === QUALITY ===
            { id: 'quality-spot', title: 'Quality Spot Check', photo: true, category: 'Quality' },
            { id: 'alignment-check', title: 'Prop Alignment Verified', photo: false, category: 'Quality' },
            { id: 'paint-touch', title: 'Paint / Touch-Up Complete', photo: true, category: 'Quality' },
            
            // === ISSUES & BLOCKERS ===
            { id: 'issues-logged', title: 'Issues Documented in App', photo: false, category: 'Issues' },
            { id: 'blockers-reported', title: 'Blockers Reported to Bob/Zac', photo: false, category: 'Issues' },
            { id: 'missing-parts', title: 'Missing Parts List Updated', photo: false, category: 'Issues' },
            
            // === END OF DAY ===
            { id: 'tools-secured', title: 'Tools Secured / Locked Up', photo: false, category: 'Closeout' },
            { id: 'materials-covered', title: 'Materials Covered / Protected', photo: true, category: 'Closeout' },
            { id: 'area-cleaned', title: 'Work Area Cleaned', photo: true, category: 'Closeout' },
            { id: 'site-secured', title: 'Site Secured & Gates Locked', photo: true, category: 'Closeout' },
            { id: 'eod-report', title: 'End of Day Report Submitted', photo: false, category: 'Closeout' },
            { id: 'tomorrow-plan', title: 'Tomorrow\'s Plan Confirmed', photo: false, category: 'Closeout' }
        ];
        
        const SHOW_TASKS = [
            // === ARRIVAL ===
            { id: 'arrival', title: 'Arrived On Site', photo: false, category: 'Arrival' },
            { id: 'gps-checkin', title: 'GPS Check-In Verified', photo: false, category: 'Arrival' },
            { id: 'uniform-check', title: 'Uniform / Badge On', photo: false, category: 'Arrival' },
            { id: 'radio-check', title: 'Radio Check Complete', photo: false, category: 'Arrival' },
            
            // === PRE-SHOW SYSTEMS ===
            { id: 'pre-walk', title: 'Pre-Show Walkthrough', photo: true, category: 'Pre-Show' },
            { id: 'pixel-power', title: 'All Pixel Controllers Powered', photo: false, category: 'Pre-Show' },
            { id: 'pixel-test', title: 'Pixel Test Sequence Run', photo: true, category: 'Pre-Show' },
            { id: 'dead-pixels', title: 'Dead Pixels Documented', photo: true, category: 'Pre-Show' },
            { id: 'audio-test', title: 'Audio System Test', photo: false, category: 'Pre-Show' },
            { id: 'speaker-check', title: 'All Speakers Verified', photo: false, category: 'Pre-Show' },
            { id: 'fm-transmitter', title: 'FM Transmitter Online', photo: false, category: 'Pre-Show' },
            
            // === POWER & GENERATORS ===
            { id: 'generator-start', title: 'Generators Started', photo: false, category: 'Power' },
            { id: 'generator-fuel', title: 'Generator Fuel Level Checked', photo: true, category: 'Power' },
            { id: 'generator-oil', title: 'Generator Oil Level Checked', photo: false, category: 'Power' },
            { id: 'power-distro', title: 'Power Distribution Verified', photo: false, category: 'Power' },
            { id: 'backup-ready', title: 'Backup Power Ready', photo: false, category: 'Power' },
            
            // === NETWORK & SYNC ===
            { id: 'fpp-sync', title: 'FPP Players Synced', photo: false, category: 'Network' },
            { id: 'network-check', title: 'Network / WiFi Verified', photo: false, category: 'Network' },
            { id: 'master-player', title: 'Master Player Online', photo: false, category: 'Network' },
            
            // === VENUE READY ===
            { id: 'entrance-ready', title: 'Entrance Gates Ready', photo: false, category: 'Venue' },
            { id: 'exit-clear', title: 'Exit Path Clear', photo: false, category: 'Venue' },
            { id: 'tent-check', title: 'Tent Manager Check-In', photo: false, category: 'Venue' },
            { id: 'safety-lane', title: 'Safety Lane Clear', photo: false, category: 'Venue' },
            { id: 'cones-placed', title: 'Traffic Cones Placed', photo: true, category: 'Venue' },
            
            // === SHOW RUNNING ===
            { id: 'show-start', title: 'Show Started On Time', photo: false, category: 'Show' },
            { id: 'first-car', title: 'First Car Entered', photo: false, category: 'Show' },
            { id: 'mid-show-check', title: 'Mid-Show Systems Check', photo: false, category: 'Show' },
            { id: 'issue-handled', title: 'Issues Handled / Escalated', photo: false, category: 'Show' },
            { id: 'crowd-flow', title: 'Traffic Flow Monitored', photo: false, category: 'Show' },
            
            // === POST-SHOW ===
            { id: 'last-car', title: 'Last Car Exited', photo: false, category: 'Closeout' },
            { id: 'show-stop', title: 'Show Sequence Stopped', photo: false, category: 'Closeout' },
            { id: 'generators-off', title: 'Generators Shut Down', photo: false, category: 'Closeout' },
            { id: 'systems-off', title: 'All Systems Powered Down', photo: false, category: 'Closeout' },
            { id: 'site-walk', title: 'Post-Show Site Walk', photo: true, category: 'Closeout' },
            { id: 'damage-check', title: 'Damage / Issues Documented', photo: true, category: 'Closeout' },
            { id: 'site-secured', title: 'Site Secured & Locked', photo: true, category: 'Closeout' },
            { id: 'nightly-report', title: 'Nightly Report Submitted', photo: false, category: 'Closeout' },
            { id: 'car-count', title: 'Car Count Logged', photo: false, category: 'Closeout' }
        ];
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SUPABASE DATA LAYER ‚Äî Field Ops
        // Tables: field_ops_staff, field_ops_checkins, field_ops_tasks, field_ops_issues
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const SUPABASE_URL = 'https://gwjtfcrgpxclixonogpe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3anRmY3JncHhjbGl4b25vZ3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzQzOTUsImV4cCI6MjA4NTkxMDM5NX0.qM1-_VA1Dsx_nsWkeoAJvNWNgSuuwApPBGoJU32X3-I';
        const SB_HEADERS = { apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json' };
        const SB_HEADERS_RO = { apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY };

        async function sbFetch(path, opts = {}) {
          const hdrs = opts.body ? { ...SB_HEADERS, ...(opts.extraHeaders || {}) } : SB_HEADERS_RO;
          delete opts.extraHeaders;
          const res = await fetch(SUPABASE_URL + '/rest/v1/' + path, { headers: hdrs, ...opts });
          if (!res.ok) throw new Error(`Supabase ${res.status}: ${await res.text()}`);
          const text = await res.text();
          return text ? JSON.parse(text) : null;
        }

        // Toast system
        function foShowToast(msg, type='info', dur=4000) {
          let c = document.getElementById('fo-toasts');
          if (!c) { c = document.createElement('div'); c.id='fo-toasts'; c.style.cssText='position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px;max-width:340px;'; document.body.appendChild(c); }
          const colors = { success:'rgba(6,214,160,0.95)', error:'rgba(239,68,68,0.95)', warning:'rgba(249,115,22,0.95)', info:'rgba(168,85,247,0.95)' };
          const t = document.createElement('div');
          t.style.cssText = `background:${colors[type]};color:white;padding:14px 18px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);font-size:14px;`;
          t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), dur);
        }

        const FieldOpsDB = {
          online: navigator.onLine,
          
          // ‚îÄ‚îÄ Staff ‚îÄ‚îÄ
          async loadStaff() {
            try {
              const rows = await sbFetch('field_ops_staff?select=*&order=created_at.asc');
              localStorage.setItem('fo_staff', JSON.stringify(rows));
              return rows;
            } catch (e) {
              console.error('[FO] loadStaff:', e);
              return JSON.parse(localStorage.getItem('fo_staff') || '[]');
            }
          },
          async addStaff(s) {
            const row = { name: s.name, phone: s.phone, role: s.role, venue_id: s.venueId };
            try {
              await sbFetch('field_ops_staff', { method: 'POST', body: JSON.stringify(row), extraHeaders: { Prefer: 'return=minimal' } });
              foShowToast('‚òÅÔ∏è Staff added', 'success', 2000);
              return true;
            } catch (e) {
              console.error('[FO] addStaff:', e);
              foShowToast('‚ö†Ô∏è Save failed, stored locally', 'warning');
              return false;
            }
          },

          // ‚îÄ‚îÄ Check-ins ‚îÄ‚îÄ
          async loadCheckins(date) {
            date = date || new Date().toISOString().split('T')[0];
            try {
              const rows = await sbFetch(`field_ops_checkins?check_in_time=gte.${date}T00:00:00&check_in_time=lt.${date}T23:59:59&select=*`);
              localStorage.setItem('fo_checkins_' + date, JSON.stringify(rows));
              return rows;
            } catch (e) {
              return JSON.parse(localStorage.getItem('fo_checkins_' + date) || '[]');
            }
          },
          async checkIn(employee_id, employee_name, venue_id, role, gpsData) {
            const row = { venue_id, employee_id, employee_name, role, check_in_time: new Date().toISOString(), notes: gpsData ? `GPS: ${gpsData.lat},${gpsData.lng}` : '' };
            try {
              await sbFetch('field_ops_checkins', { method: 'POST', body: JSON.stringify(row), extraHeaders: { Prefer: 'return=minimal' } });
              return true;
            } catch (e) { console.error('[FO] checkIn:', e); return false; }
          },

          // ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ
          async loadTasks(date) {
            date = date || new Date().toISOString().split('T')[0];
            try {
              const rows = await sbFetch(`field_ops_tasks?completed_at=gte.${date}T00:00:00&completed_at=lt.${date}T23:59:59&select=*`);
              localStorage.setItem('fo_tasks_' + date, JSON.stringify(rows));
              return rows;
            } catch (e) {
              return JSON.parse(localStorage.getItem('fo_tasks_' + date) || '[]');
            }
          },
          async completeTask(venue_id, task_id, mode, completed_by) {
            const row = { venue_id, task_id, mode, completed_by, completed_at: new Date().toISOString() };
            try {
              await sbFetch('field_ops_tasks', { method: 'POST', body: JSON.stringify(row), extraHeaders: { Prefer: 'return=minimal' } });
              return true;
            } catch (e) { console.error('[FO] completeTask:', e); return false; }
          },
          async uncompleteTask(venue_id, task_id, mode) {
            try {
              await sbFetch(`field_ops_tasks?venue_id=eq.${venue_id}&task_id=eq.${task_id}&mode=eq.${mode}`, { method: 'DELETE' });
              return true;
            } catch (e) { console.error('[FO] uncompleteTask:', e); return false; }
          },

          // ‚îÄ‚îÄ Issues ‚îÄ‚îÄ
          async loadIssues() {
            try {
              const rows = await sbFetch('field_ops_issues?select=*&order=reported_at.desc');
              localStorage.setItem('fo_issues', JSON.stringify(rows));
              return rows;
            } catch (e) {
              return JSON.parse(localStorage.getItem('fo_issues') || '[]');
            }
          },
          async addIssue(issue) {
            const row = { venue_id: issue.venueId, issue_type: issue.type || 'general', description: issue.description, priority: issue.priority || 'medium', reported_by: issue.reportedBy, status: 'open', reported_at: new Date().toISOString() };
            try {
              await sbFetch('field_ops_issues', { method: 'POST', body: JSON.stringify(row), extraHeaders: { Prefer: 'return=minimal' } });
              foShowToast('‚òÅÔ∏è Issue reported', 'success', 2000);
              return true;
            } catch (e) { foShowToast('‚ö†Ô∏è Failed to save issue', 'error'); return false; }
          },
          async resolveIssue(id, resolvedBy, notes) {
            try {
              await sbFetch(`field_ops_issues?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify({ status: 'resolved', resolved_at: new Date().toISOString(), resolution_notes: notes || '', updated_at: new Date().toISOString() }) });
              return true;
            } catch (e) { return false; }
          }
        };

        window.addEventListener('online', () => { FieldOpsDB.online = true; });
        window.addEventListener('offline', () => { FieldOpsDB.online = false; });

        // ========== STATE ==========
        let currentPin = '';
        let currentUser = null;
        let currentMode = 'build';
        let currentVenue = null;
        
        // These now load from Supabase (initialized empty, populated in init())
        let staff = [];
        let checkIns = {};
        let taskCompletions = {};
        let issues = [];
        
        // ========== PIN LOGIN ==========
        function addPin(digit) {
            if (currentPin.length < 4) {
                currentPin += digit;
                updatePinDisplay();
                
                if (currentPin.length === 4) {
                    setTimeout(checkPin, 200);
                }
            }
        }
        
        function clearPin() {
            currentPin = '';
            updatePinDisplay();
            document.getElementById('loginError').classList.remove('show');
        }
        
        function backspace() {
            currentPin = currentPin.slice(0, -1);
            updatePinDisplay();
        }
        
        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById('dot' + i);
                dot.classList.toggle('filled', i <= currentPin.length);
            }
        }
        
        function checkPin() {
            if (PINS[currentPin]) {
                currentUser = PINS[currentPin];
                localStorage.setItem('fieldops-user', JSON.stringify(currentUser));
                showApp();
            } else {
                document.getElementById('loginError').classList.add('show');
                currentPin = '';
                updatePinDisplay();
                
                // Shake animation
                const display = document.querySelector('.pin-display');
                display.style.animation = 'shake 0.5s';
                setTimeout(() => display.style.animation = '', 500);
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('fieldops-user');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
            clearPin();
        }
        
        function showApp() {
            // Store session for TLPPermissions compatibility
            if (currentUser) {
                const session = {
                    id: 'user_' + currentUser.name.toLowerCase().replace(/\s+/g, '_'),
                    name: currentUser.name,
                    role: currentUser.role === 'tech-lead' ? 'tech_lead' : currentUser.role,
                    apps: ['field-ops', 'employee-app', 'training-hub'],
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                };
                localStorage.setItem('tlpSession', JSON.stringify(session));
                
                // Log access
                if (typeof TLPPermissions !== 'undefined') {
                    TLPPermissions.logAction('login', `Logged into Field Ops as ${currentUser.name}`);
                }
            }
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            renderDashboard();
        }
        
        // ========== MODE TOGGLE ==========
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('buildModeBtn').classList.toggle('active', mode === 'build');
            document.getElementById('showModeBtn').classList.toggle('active', mode === 'show');
            document.getElementById('staffSectionTitle').textContent = mode === 'build' ? 'Build Leads' : 'Show Techs';
            renderDashboard();
        }
        
        // ========== DASHBOARD ==========
        function renderDashboard() {
            renderVenueGrid();
            renderIssues();
            renderStaffList();
        }
        
        function renderVenueGrid() {
            const grid = document.getElementById('venueGrid');
            grid.innerHTML = VENUES.map(venue => {
                const venueStaff = getVenueStaff(venue.id);
                const checkedIn = venueStaff.filter(s => isCheckedInToday(s.id)).length;
                const tasks = getVenueTasks(venue.id);
                const completedTasks = tasks.filter(t => isTaskComplete(venue.id, t.id)).length;
                
                let status = 'gray';
                if (venueStaff.length > 0) {
                    if (checkedIn === venueStaff.length && completedTasks >= tasks.length * 0.8) {
                        status = 'green';
                    } else if (checkedIn > 0 || completedTasks > 0) {
                        status = 'yellow';
                    } else {
                        status = 'red';
                    }
                }
                
                return `
                    <div class="venue-card status-${status}" onclick="showVenueDetail('${venue.id}')">
                        <h4 class="venue-name">${venue.name}</h4>
                        <div class="venue-stats">
                            <span class="venue-stat">
                                <span class="${checkedIn === venueStaff.length && venueStaff.length > 0 ? 'check' : checkedIn > 0 ? 'pending' : 'missing'}">üë§</span>
                                ${checkedIn}/${venueStaff.length}
                            </span>
                            <span class="venue-stat">
                                <span class="${completedTasks === tasks.length ? 'check' : completedTasks > 0 ? 'pending' : 'missing'}">‚úì</span>
                                ${completedTasks}/${tasks.length}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderIssues() {
            const section = document.getElementById('issuesSection');
            const list = document.getElementById('issuesList');
            
            const activeIssues = issues.filter(i => !i.resolved);
            
            if (activeIssues.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = activeIssues.map(issue => `
                <div class="issue-card">
                    <div class="issue-header">
                        <span class="issue-venue">${getVenueName(issue.venueId)}</span>
                        <span class="issue-time">${formatTime(issue.createdAt)}</span>
                    </div>
                    <h4 class="issue-title">${issue.title}</h4>
                    <p class="issue-desc">${issue.description}</p>
                    <div class="issue-actions">
                        <button class="issue-btn resolve" onclick="resolveIssue('${issue.id}')">‚úì Resolve</button>
                        <button class="issue-btn escalate" onclick="escalateIssue('${issue.id}')">üìû Call Staff</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderStaffList() {
            const list = document.getElementById('staffList');
            const roleFilter = currentMode === 'build' ? 'build-lead' : 'show-tech';
            const filteredStaff = staff.filter(s => s.role === roleFilter);
            
            if (filteredStaff.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h4 class="empty-state-title">No ${currentMode === 'build' ? 'Build Leads' : 'Show Techs'} Yet</h4>
                        <p>Add staff members to start tracking</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredStaff.map(s => {
                const checkedIn = isCheckedInToday(s.id);
                const checkInData = getCheckInData(s.id);
                
                return `
                    <div class="staff-card">
                        <div class="staff-info">
                            <div class="staff-avatar">${getInitials(s.name)}</div>
                            <div class="staff-details">
                                <h4>${s.name}</h4>
                                <p>${getVenueName(s.venueId)} ‚Ä¢ ${s.phone || 'No phone'}</p>
                            </div>
                        </div>
                        <div class="staff-status">
                            <span class="status-badge ${checkedIn ? 'checked-in' : 'not-checked-in'}">
                                ${checkedIn ? 'Checked In' : 'Not Checked In'}
                            </span>
                            ${checkedIn ? `
                                <span class="check-in-time">${formatTime(checkInData.time)}</span>
                                ${checkInData.gps ? '<span class="gps-verified">üìç GPS Verified</span>' : ''}
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== VENUE DETAIL ==========
        function showVenueDetail(venueId) {
            currentVenue = venueId;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('venueDetailView').classList.add('active');
            
            const venue = VENUES.find(v => v.id === venueId);
            const venueStaff = getVenueStaff(venueId);
            const tasks = getVenueTasks(venueId);
            const completedTasks = tasks.filter(t => isTaskComplete(venueId, t.id)).length;
            
            document.getElementById('detailVenueName').textContent = venue.name;
            document.getElementById('detailStaffCount').textContent = `${venueStaff.length} Staff Assigned`;
            document.getElementById('detailTaskProgress').textContent = `${completedTasks}/${tasks.length} Tasks Done`;
            
            renderChecklist(venueId);
            renderVenueStaff(venueId);
            loadCADNotes(venueId);
        }
        
        function loadCADNotes(venueId) {
            try {
                const cadNotesData = localStorage.getItem('cad_field_notes');
                if (!cadNotesData) {
                    document.getElementById('cadNotesSection').style.display = 'none';
                    return;
                }
                
                const notes = JSON.parse(cadNotesData);
                const venueNotes = notes[venueId];
                
                if (!venueNotes || !venueNotes.notes) {
                    document.getElementById('cadNotesSection').style.display = 'none';
                    return;
                }
                
                // Show notes section
                document.getElementById('cadNotesSection').style.display = 'block';
                document.getElementById('cadNotesContent').textContent = venueNotes.notes;
                
                // Format timestamp
                const timestamp = new Date(venueNotes.updatedAt);
                const timeAgo = formatTimeAgo(timestamp);
                document.getElementById('cadNotesTimestamp').textContent = `Updated ${timeAgo} by ${venueNotes.updatedBy}`;
            } catch (err) {
                console.error('Error loading CAD notes:', err);
                document.getElementById('cadNotesSection').style.display = 'none';
            }
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days === 1) return 'yesterday';
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }
        
        function showDashboard() {
            currentVenue = null;
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('venueDetailView').classList.remove('active');
            renderDashboard();
        }
        
        function renderChecklist(venueId) {
            const container = document.getElementById('checklistItems');
            const tasks = getVenueTasks(venueId);
            
            // Group tasks by category
            const grouped = {};
            tasks.forEach(task => {
                const cat = task.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(task);
            });
            
            let html = '';
            for (const [category, categoryTasks] of Object.entries(grouped)) {
                const completedInCat = categoryTasks.filter(t => isTaskComplete(venueId, t.id)).length;
                html += `
                    <div class="checklist-category">
                        <div class="category-header">
                            <span class="category-name">${category}</span>
                            <span class="category-progress ${completedInCat === categoryTasks.length ? 'complete' : ''}">${completedInCat}/${categoryTasks.length}</span>
                        </div>
                        ${categoryTasks.map(task => {
                            const isComplete = isTaskComplete(venueId, task.id);
                            const taskData = getTaskData(venueId, task.id);
                            
                            return `
                                <div class="checklist-item ${isComplete ? 'done' : ''}">
                                    <div class="checklist-checkbox ${isComplete ? 'checked' : ''}" 
                                         onclick="toggleTask('${venueId}', '${task.id}')">
                                        ${isComplete ? '‚úì' : ''}
                                    </div>
                                    <div class="checklist-content">
                                        <h4 class="checklist-title">${task.title}</h4>
                                        ${isComplete ? `
                                            <p class="checklist-meta">
                                                ${taskData.completedBy || 'Staff'} ‚Ä¢ ${formatTime(taskData.completedAt)}
                                            </p>
                                        ` : ''}
                                        ${task.photo ? '<span class="photo-required">üì∑ Photo</span>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function renderVenueStaff(venueId) {
            const list = document.getElementById('venueStaffList');
            const venueStaff = getVenueStaff(venueId);
            
            if (venueStaff.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>No staff assigned to this venue</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = venueStaff.map(s => {
                const checkedIn = isCheckedInToday(s.id);
                const checkInData = getCheckInData(s.id);
                
                return `
                    <div class="staff-card">
                        <div class="staff-info">
                            <div class="staff-avatar">${getInitials(s.name)}</div>
                            <div class="staff-details">
                                <h4>${s.name}</h4>
                                <p>${s.role === 'build-lead' ? 'Build Lead' : 'Show Tech'}</p>
                            </div>
                        </div>
                        <div class="staff-status">
                            <span class="status-badge ${checkedIn ? 'checked-in' : 'not-checked-in'}">
                                ${checkedIn ? 'Checked In' : 'Not Checked In'}
                            </span>
                            ${checkedIn && checkInData.gps ? '<span class="gps-verified">üìç GPS Verified</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== MODALS ==========
        function openAddStaffModal() {
            document.getElementById('addStaffModal').classList.add('active');
            document.getElementById('staffRole').value = currentMode === 'build' ? 'build-lead' : 'show-tech';
        }
        
        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }
        
        async function addStaff() {
            const name = document.getElementById('staffName').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();
            const role = document.getElementById('staffRole').value;
            const venueId = document.getElementById('staffVenue').value;
            
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            // Save to Supabase first
            await FieldOpsDB.addStaff({ name, phone, role, venueId });
            
            // Reload staff from cloud
            staff = await FieldOpsDB.loadStaff();
            saveData();
            closeModal();
            renderDashboard();
            
            // Clear form
            document.getElementById('staffName').value = '';
            document.getElementById('staffPhone').value = '';
        }
        
        // ========== ACTIONS ==========
        async function toggleTask(venueId, taskId) {
            const key = `${venueId}-${taskId}`;
            const today = getTodayKey();
            
            if (!taskCompletions[today]) {
                taskCompletions[today] = {};
            }
            
            if (taskCompletions[today][key]) {
                delete taskCompletions[today][key];
                // Remove from Supabase
                await FieldOpsDB.uncompleteTask(venueId, taskId, currentMode);
            } else {
                taskCompletions[today][key] = {
                    completedAt: new Date().toISOString(),
                    completedBy: currentUser ? currentUser.name : 'User'
                };
                // Save to Supabase
                await FieldOpsDB.completeTask(venueId, taskId, currentMode, currentUser ? currentUser.name : 'User');
            }
            
            saveData();
            if (currentVenue) {
                renderChecklist(currentVenue);
            }
            renderDashboard();
        }
        
        async function resolveIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (issue) {
                issue.resolved = true;
                issue.resolvedAt = new Date().toISOString();
                issue.resolvedBy = currentUser ? currentUser.name : 'User';
                // Sync to Supabase
                await FieldOpsDB.resolveIssue(issueId, issue.resolvedBy);
                saveData();
                renderIssues();
                foShowToast('‚úÖ Issue resolved', 'success', 2000);
            }
        }
        
        function escalateIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (issue) {
                const staffMember = staff.find(s => s.venueId === issue.venueId);
                if (staffMember && staffMember.phone) {
                    window.location.href = `tel:${staffMember.phone}`;
                } else {
                    alert('No phone number available for staff at this venue');
                }
            }
        }
        
        // ========== HELPERS ==========
        function getVenueStaff(venueId) {
            const roleFilter = currentMode === 'build' ? 'build-lead' : 'show-tech';
            return staff.filter(s => s.venueId === venueId && s.role === roleFilter);
        }
        
        function getVenueTasks(venueId) {
            return currentMode === 'build' ? BUILD_TASKS : SHOW_TASKS;
        }
        
        function getVenueName(venueId) {
            const venue = VENUES.find(v => v.id === venueId);
            return venue ? venue.name : venueId;
        }
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }
        
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }
        
        function isCheckedInToday(staffId) {
            const today = getTodayKey();
            return checkIns[today] && checkIns[today][staffId];
        }
        
        function getCheckInData(staffId) {
            const today = getTodayKey();
            return (checkIns[today] && checkIns[today][staffId]) || {};
        }
        
        function isTaskComplete(venueId, taskId) {
            const today = getTodayKey();
            const key = `${venueId}-${taskId}`;
            return taskCompletions[today] && taskCompletions[today][key];
        }
        
        function getTaskData(venueId, taskId) {
            const today = getTodayKey();
            const key = `${venueId}-${taskId}`;
            return (taskCompletions[today] && taskCompletions[today][key]) || {};
        }
        
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }
        
        // saveData now syncs to Supabase proper tables (handled by individual operations)
        // This function just updates localStorage cache for offline access
        async function saveData() {
            localStorage.setItem('fieldops-staff', JSON.stringify(staff));
            localStorage.setItem('fieldops-checkins', JSON.stringify(checkIns));
            localStorage.setItem('fieldops-tasks', JSON.stringify(taskCompletions));
            localStorage.setItem('fieldops-issues', JSON.stringify(issues));
            updateSyncStatusUI(true);
        }

        function updateSyncStatusUI(synced) {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            if (synced) {
                statusEl.textContent = '‚òÅÔ∏è ' + new Date().toLocaleTimeString();
                statusEl.style.color = '#06d6a0';
            } else {
                statusEl.textContent = 'üì± Local';
                statusEl.style.color = '#8888a0';
            }
        }
        
        // Shared employees now loaded directly from field_ops_staff Supabase table
        
        function switchTab(tab) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', ['dashboard', 'staff', 'tasks', 'reports'][i] === tab);
            });
            
            // For now, all tabs show dashboard - can expand later
            showDashboard();
        }
        
        // ========== INIT ==========
        async function init() {
            // Use Supabase auth profile if available
            if (window.currentUserProfile) {
                currentUser = { name: window.currentUserProfile.display_name || 'User', role: window.currentUserProfile.role || 'owner' };
            } else {
                currentUser = { name: 'User', role: 'owner' };
            }
            showApp();

            // Load all data from Supabase proper tables
            try {
                staff = await FieldOpsDB.loadStaff();
                
                // Load today's checkins and convert to legacy format
                const today = getTodayKey();
                const checkinRows = await FieldOpsDB.loadCheckins(today);
                checkIns[today] = {};
                checkinRows.forEach(c => {
                    checkIns[today][c.employee_id] = {
                        time: c.check_in_time,
                        gps: c.notes?.startsWith('GPS:'),
                        venue: c.venue_id
                    };
                });
                
                // Load today's tasks and convert to legacy format
                const taskRows = await FieldOpsDB.loadTasks(today);
                taskCompletions[today] = {};
                taskRows.forEach(t => {
                    const key = `${t.venue_id}-${t.task_id}`;
                    taskCompletions[today][key] = {
                        completedAt: t.completed_at,
                        completedBy: t.completed_by
                    };
                });
                
                // Load issues
                const issueRows = await FieldOpsDB.loadIssues();
                issues = issueRows.map(i => ({
                    id: i.id,
                    venueId: i.venue_id,
                    title: i.issue_type,
                    description: i.description,
                    createdAt: i.reported_at,
                    resolved: i.status === 'resolved',
                    resolvedAt: i.resolved_at
                }));
                
                updateSyncStatusUI(true);
                console.log('[Field Ops] ‚úÖ Loaded from Supabase: staff=' + staff.length + ' checkins=' + checkinRows.length + ' tasks=' + taskRows.length + ' issues=' + issueRows.length);
            } catch (e) {
                console.error('[Field Ops] Supabase load failed, using localStorage:', e);
                staff = JSON.parse(localStorage.getItem('fieldops-staff') || '[]');
                checkIns = JSON.parse(localStorage.getItem('fieldops-checkins') || '{}');
                taskCompletions = JSON.parse(localStorage.getItem('fieldops-tasks') || '{}');
                issues = JSON.parse(localStorage.getItem('fieldops-issues') || '[]');
                updateSyncStatusUI(false);
            }
            
            // Map staff from Supabase format to local format
            staff = staff.map(s => ({
                id: s.id,
                name: s.name,
                phone: s.phone || '',
                role: s.role || 'build-lead',
                venueId: s.venue_id || 'katy',
                createdAt: s.created_at
            }));
            
            // Seed demo data if DB is empty
            if (staff.length === 0) {
                const demoStaff = [
                    { name: 'Mike Rodriguez', phone: '(832) 555-0101', role: 'build-lead', venueId: 'katy' },
                    { name: 'Sarah Chen', phone: '(210) 555-0102', role: 'build-lead', venueId: 'selma' },
                    { name: 'James Wilson', phone: '(817) 555-0103', role: 'build-lead', venueId: 'arlington' },
                    { name: 'Alex Turner', phone: '(832) 555-0201', role: 'show-tech', venueId: 'katy' },
                    { name: 'Maria Santos', phone: '(210) 555-0202', role: 'show-tech', venueId: 'selma' }
                ];
                for (const s of demoStaff) await FieldOpsDB.addStaff(s);
                staff = await FieldOpsDB.loadStaff();
                staff = staff.map(s => ({ id: s.id, name: s.name, phone: s.phone || '', role: s.role, venueId: s.venue_id, createdAt: s.created_at }));
            }
            
            saveData();
            renderDashboard();
            
            // Poll for updates every 15s
            setInterval(async () => {
                try {
                    const today = getTodayKey();
                    const taskRows = await FieldOpsDB.loadTasks(today);
                    taskCompletions[today] = {};
                    taskRows.forEach(t => {
                        taskCompletions[today][`${t.venue_id}-${t.task_id}`] = { completedAt: t.completed_at, completedBy: t.completed_by };
                    });
                    const issueRows = await FieldOpsDB.loadIssues();
                    issues = issueRows.map(i => ({ id: i.id, venueId: i.venue_id, title: i.issue_type, description: i.description, createdAt: i.reported_at, resolved: i.status === 'resolved' }));
                    renderDashboard();
                    if (currentVenue) renderChecklist(currentVenue);
                } catch (e) { /* silent polling failure */ }
            }, 15000);
        }
        
        // Shake animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                20%, 60% { transform: translateX(-10px); }
                40%, 80% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // Fix: userName element for demo mode
        if (!document.getElementById('userName')) {
            const badge = document.querySelector('.user-badge');
            if (badge) { badge.id = 'userName'; }
        }
        
        init();
    </script>
</body>
</html>
